services:
  borgmatic:
    image: ghcr.io/borgmatic-collective/borgmatic:latest
    container_name: borgmatic
    restart: unless-stopped

    volumes:
      - /opt/docker:/mnt/source:ro  # ğŸ” Maps your entire stack (read-only) as the backup source
      - ${DOCKER_DATA_DIR}/borgmatic:/etc/borgmatic  # âš™ï¸ Config folder (holds config.yaml + .env)
      - ${DOCKER_DATA_DIR}/borgmatic/.ssh:/root/.ssh  # ğŸ” SSH key pair for BorgBase access
      - ${DOCKER_DATA_DIR}/borgmatic/repo:/mnt/borg-repository  # ğŸ’¾ Optional local repo folder (not used)
      - ${DOCKER_DATA_DIR}/borgmatic/borg:/root/.config/borg  # ğŸ§  Borg key and config files
      - ${DOCKER_DATA_DIR}/borgmatic/cache:/root/.cache/borg  # âš¡ Cache for deduplication and performance

    environment:
      - TZ=${TZ}  # ğŸŒ Timezone from main .env
      - PUID=${PUID}  # ğŸ‘¤ Your user ID (for file permissions)
      - PGID=${PGID}  # ğŸ‘¥ Your group ID
      - BORG_PASSPHRASE=${BORG_PASSPHRASE}  # ğŸ” Secure passphrase (don't hardcode in config.yaml)
      - BORG_REPO_URL=${BORG_REPO_URL}  # ğŸ“¦ BorgBase SSH repository path
      - BACKUP_CRON=0 4 * * 0  # ğŸ•“ Weekly backup: Every Sunday at 4 AM
      - RUN_ON_STARTUP=true   # ğŸš€ Trigger a backup when the container starts

    profiles:
      - borgmatic  # ğŸ§© Use this profile to selectively start this service
      - all        # âœ… Include in full stack if needed
